<html>
    <head>
    <style>
    /* CSS para inserir no construtor Bitrix */
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f0f0f0;
        border-top: 4px solid #25D366;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    #qr-container {
        max-width: 400px;
        margin: 0 auto;
        padding: 20px;
    }

    #qr-success div:first-child {
        animation: pulse 0.6s ease-in-out;
    }

    @keyframes pulse {
        0% { transform: scale(0.8); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    </style>

    <script>
    // JavaScript para inserir no construtor Bitrix
    class WhatsAppQRConnector {
        constructor() {
            this.token = this.getTokenFromURL();
            this.timeLeft = 30; // 30 segundos
            this.checkInterval = null;
            this.timerInterval = null;
            this.renewInterval = null;
            this.renewAfter = 25; // Renova ap√≥s 25 segundos (5 segundos antes do vencimento)
            this.renewCounter = 0;
            this.maxRenewals = 10; // M√°ximo 10 renova√ß√µes autom√°ticas
            this.apiBaseUrl = 'https://workflow.agenciaasa.com.br/webhook-test';
            
            this.init();
        }
        
        getTokenFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }
        
        init() {
            console.log('Inicializando WhatsAppQRConnector...');
            console.log('URL atual:', window.location.href);
            console.log('Token encontrado:', this.token);
            
            if (!this.token) {
                this.showError('Token n√£o encontrado na URL');
                return;
            }
            
            this.startTimer();
            this.fetchQRCode();
            this.scheduleRenewal();
        }
        
        showLoading() {
            document.getElementById('qr-loading').style.display = 'block';
            document.getElementById('qr-display').style.display = 'none';
            document.getElementById('qr-success').style.display = 'none';
            document.getElementById('qr-error').style.display = 'none';
        }
        
        showQRCode(qrImageData) {
            // Limpa intervalos anteriores antes de mostrar novo QR
            if (this.checkInterval) clearInterval(this.checkInterval);
            
            document.getElementById('qr-loading').style.display = 'none';
            document.getElementById('qr-display').style.display = 'block';
            document.getElementById('qr-image').src = qrImageData;
            
            this.startStatusCheck();
            
            // Mostra contador de renova√ß√µes se houver
            if (this.renewCounter > 0) {
                this.updateStatusMessage(`‚è≥ QR Code renovado automaticamente (${this.renewCounter}/${this.maxRenewals})`);
            }
        }
        
        showSuccess() {
            this.clearAllIntervals();
            document.getElementById('qr-display').style.display = 'none';
            document.getElementById('qr-success').style.display = 'block';
        }
        
        showError(message) {
            this.clearAllIntervals();
            document.getElementById('qr-loading').style.display = 'none';
            document.getElementById('qr-display').style.display = 'none';
            document.getElementById('qr-error').style.display = 'block';
            if (message) {
                document.querySelector('#qr-error p').textContent = '‚ùå ' + message;
            }
        }
        
        updateTimer() {
            if (this.timeLeft <= 0) {
                if (this.renewCounter < this.maxRenewals) {
                    this.renewQRCode();
                    return;
                } else {
                    this.showError('QR Code expirado. M√°ximo de renova√ß√µes atingido.');
                    return;
                }
            }
            
            const minutes = Math.floor(this.timeLeft / 60);
            const seconds = this.timeLeft % 60;
            document.getElementById('timer-display').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Aviso quando restam 10 segundos
            if (this.timeLeft === 10 && this.renewCounter < this.maxRenewals) {
                this.updateStatusMessage('‚ö†Ô∏è QR Code ser√° renovado em breve...');
            }
            
            this.timeLeft--;
        }
        
        startTimer() {
            this.updateTimer();
            this.timerInterval = setInterval(() => this.updateTimer(), 1000);
        }
        
        async fetchQRCode() {
            try {
                console.log('Iniciando busca do QR Code...');
                console.log('Token:', this.token);
                console.log('URL:', `${this.apiBaseUrl}/qrcode?token=${this.token}`);
                
                this.showLoading();
                
                const response = await fetch(`${this.apiBaseUrl}/qrcode?token=${this.token}`);
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success && data.qrCode) {
                    this.showQRCode(data.qrCode);
                } else {
                    throw new Error(data.message || 'Falha ao gerar QR Code');
                }
            } catch (error) {
                console.error('Erro ao buscar QR Code:', error);
                this.showError('Erro ao carregar QR Code: ' + error.message);
            }
        }
        
        async checkStatus() {
            try {
                const response = await fetch(`${this.apiBaseUrl}/qrcode-status?token=${this.token}`);
                
                if (!response.ok) return;
                
                const data = await response.json();
                
                if (data.connected) {
                    this.showSuccess();
                }
            } catch (error) {
                console.error('Erro ao verificar status:', error);
            }
        }
        
        startStatusCheck() {
            // Garante que n√£o h√° verifica√ß√£o anterior rodando
            if (this.checkInterval) {
                clearInterval(this.checkInterval);
                this.checkInterval = null;
            }
            
            console.log('Iniciando verifica√ß√£o de status...');
            this.checkInterval = setInterval(() => this.checkStatus(), 3000);
        }
        
        clearAllIntervals() {
            if (this.timerInterval) {
                clearInterval(this.timerInterval);
                this.timerInterval = null;
            }
            if (this.checkInterval) {
                clearInterval(this.checkInterval);
                this.checkInterval = null;
            }
            if (this.renewInterval) {
                clearTimeout(this.renewInterval);
                this.renewInterval = null;
            }
            console.log('Todos os intervalos foram limpos');
        }
        
        updateStatusMessage(message) {
            const statusElement = document.getElementById('qr-status');
            if (statusElement) {
                statusElement.innerHTML = message;
            }
        }
        
        scheduleRenewal() {
            // Limpa agendamento anterior se existir
            if (this.renewInterval) {
                clearTimeout(this.renewInterval);
                this.renewInterval = null;
            }
            
            console.log(`Agendando renova√ß√£o para ${this.renewAfter} segundos...`);
            this.renewInterval = setTimeout(() => {
                if (this.renewCounter < this.maxRenewals) {
                    this.renewQRCode();
                }
            }, this.renewAfter * 1000);
        }
        
        async renewQRCode() {
            try {
                console.log('Renovando QR Code automaticamente...');
                this.renewCounter++;
                
                this.updateStatusMessage('üîÑ Renovando QR Code automaticamente...');
                
                // Para TODOS os intervalos atuais
                if (this.checkInterval) {
                    clearInterval(this.checkInterval);
                    this.checkInterval = null;
                }
                if (this.renewInterval) {
                    clearTimeout(this.renewInterval);
                    this.renewInterval = null;
                }
                
                // Usa o mesmo endpoint para renova√ß√£o
                const response = await fetch(`${this.apiBaseUrl}/qrcode?token=${this.token}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.qrCode) {
                    // Reset do timer para 30 segundos
                    this.timeLeft = 30;
                    
                    // Atualiza o QR Code
                    document.getElementById('qr-image').src = data.qrCode;
                    
                    // Reinicia verifica√ß√µes (j√° limpa intervalos anteriores)
                    this.startStatusCheck();
                    
                    // Agenda pr√≥xima renova√ß√£o se n√£o atingiu o limite
                    if (this.renewCounter < this.maxRenewals) {
                        this.scheduleRenewal();
                    }
                    
                    this.updateStatusMessage(`‚úÖ QR Code renovado (${this.renewCounter}/${this.maxRenewals})`);
                    
                } else {
                    throw new Error(data.message || 'Falha ao renovar QR Code');
                }
                
            } catch (error) {
                console.error('Erro ao renovar QR Code:', error);
                this.updateStatusMessage('‚ùå Erro ao renovar QR Code');
                
                // Se falhou, tenta renova√ß√£o manual ap√≥s 10 segundos (apenas se ainda n√£o atingiu limite)
                if (this.renewCounter < this.maxRenewals) {
                    setTimeout(() => {
                        this.renewQRCode();
                    }, 10000);
                }
            }
        }
    }

    // Inicializar quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', function() {
        new WhatsAppQRConnector();
    });

    // Fallback caso DOMContentLoaded j√° tenha disparado
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            new WhatsAppQRConnector();
        });
    } else {
        new WhatsAppQRConnector();
    }
    </script>
    </head>
    <body>
        <div id="qr-container">
            <div id="qr-loading" style="text-align: center; display: none;">
                <div class="spinner"></div>
                <p>Gerando QR Code...</p>
            </div>
            
            <div id="qr-display" style="text-align: center; display: none;">
                <img id="qr-image" src="" alt="QR Code WhatsApp" style="max-width: 250px; width: 100%; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div id="qr-timer" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; font-weight: bold;">
                    Expira em: <span id="timer-display">00:30</span>
                </div>
                <div id="qr-status" style="padding: 12px; margin: 10px 0; border-radius: 8px; background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;">
                    ‚è≥ Aguardando escaneamento do QR Code
                </div>
            </div>
            
            <div id="qr-success" style="text-align: center; display: none;">
                <div style="width: 60px; height: 60px; background: #25D366; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px;">‚úì</div>
                <h3 style="color: #25D366; margin-bottom: 10px;">Conectado!</h3>
                <p style="color: #666;">Seu WhatsApp foi conectado com sucesso.</p>
            </div>
            
            <div id="qr-error" style="text-align: center; display: none; color: #dc3545;">
                <p>‚ùå Erro ao gerar QR Code ou token expirado</p>
                <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Tentar Novamente</button>
            </div>
        </div>
    </body>
</html>
